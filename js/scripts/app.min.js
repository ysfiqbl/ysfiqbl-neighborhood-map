$(document).ready(function() {
    var Category = function(title) {
        var self = this;

        self.title = ko.observable(category);
    }

    function Location(map, lat, lng, id) {
        var self = this;
        var date = ''+new Date().getTime()
        self.id = (typeof id === 'undefined') ? date : id;
        var contentString = '<div>' + self.id + '<button id="'+self.id+'">Delete</button></div>';

        self.marker = new google.maps.Marker({
            position: new google.maps.LatLng(lat, lng),
            map: map,
            title: self.id,
            draggable: true,
            infoWindow: new google.maps.InfoWindow({
                id: self.id,
                content: contentString
            })
        });
        self.title = ko.observable(self.marker.title);
        self.category = ko.observable();
        self.labels = ko.observableArray();
        self.lat = ko.observable();
        self.lng = ko.observable();
    }
    (function() {
        this.setTitle = function(title) {
            this.title(title);
            this.marker.title = title;
        };

        this.setCategory = function(category) {
            this.category(category);
        };

        this.addLabel = function(label) {
            if (this.categories.indexOf(category) < 0) {
                this.categories.push(category);
            } else {
                alert("Location already belongs to category.");
            }
        };

        this.removeLabel = function(category) {
            this.categories.remove(category);
        };
    }).call(Location.prototype);

    var ViewModel = function() {
        var self = this;
        self.localStoreLocations = [];
        self.allLocations = ko.observableArray();
        self.visibleLocations = ko.observableArray();
        self.map;

        self.initialize = function() {
            self.mapOptions = {
                zoom: 8,
                center: new google.maps.LatLng(-34.397, 150.644),
                panControl: true,
                panControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_BOTTOM
                },
                zoomControl: true,
                zoomControlOptions: {
                    style: google.maps.ZoomControlStyle.SMALL,
                    position: google.maps.ControlPosition.RIGHT_BOTTOM
                }
            };
            self.map = new google.maps.Map(document.getElementById('map-canvas'), self.mapOptions);

            self.loadLocations();

            google.maps.event.addListener(self.map, 'click', function(event) {
                var loc = new Location(self.map, event.latLng.lat(), event.latLng.lng());
                self.addLocationToMap(loc);
                self.saveLocation(loc);
            });

        }

        google.maps.event.addDomListener(window, 'load', self.initialize);

        self.removeLocation = function(loc) {
            loc.marker.setMap(null);
            self.allLocations.remove(loc);
        };

        self.addLocationToMap = function(loc) {

            google.maps.event.addListener(loc.marker, 'click', function() {
                loc.marker.infoWindow.open(self.map, loc.marker)
            });

            google.maps.event.addListener(loc.marker.infoWindow, 'domready', function() {
                    //console.log("dom ready return function " + i.title());
                $('#'+loc.marker.infoWindow.id).click(function(e) {
                    console.log("Deleting " + loc.title());
                    var button = $(e.target).text();
                    switch (button) {
                        case 'Delete':
                            self.removeLocation(loc);
                            break;
                        case 'Save':
                            console.log('Save marker ' + loc);
                            break;
                        default:
                            console.log('Default, do nothing');
                            break;
                    }
                });
            });

            /*(google.maps.event.addListener(loc.marker.infoWindow, 'domready', (function(loc) {
                return function() {

                    });
                    $(':button').click(function(e) {
                        console.log($(this) + "Deleting " + loc.title());
                        var button = $(e.target).text();
                        switch (button) {
                            case 'Delete':
                                self.removeLocation(loc);
                                break;
                            case 'Save':
                                console.log('Save marker ' + loc);
                                break;
                            default:
                                console.log('Default, do nothing');
                                break;
                        }
                    });
                }
            })(loc));*/
        };

        self.saveLocation = function(loc) {
            self.allLocations.push(loc);
            var locationJSON = {
                'id': loc.id,
                'title': loc.title(),
                'lat': loc.marker.getPosition().lat(),
                'lng': loc.marker.getPosition().lng(),
                'labels': loc.labels(),
                'category': loc.category()
            }

            self.localStoreLocations.push(locationJSON);
            localStorage.locations = JSON.stringify(self.localStoreLocations);
        };

        self.loadLocations = function() {
            if (localStorage.locations) {
                self.localStoreLocations = JSON.parse(localStorage.locations);
                for (var i = 0; i < self.localStoreLocations.length; i++) {
                    var locationJSON = self.localStoreLocations[i];
                    var loc = new Location(
                        self.map,
                        locationJSON.lat,
                        locationJSON.lng,
                        locationJSON.id
                    );
                    loc.setTitle(locationJSON.title);
                    self.addLocationToMap(loc);
                }
            }
        }
    };

    ko.applyBindings(new ViewModel());
});