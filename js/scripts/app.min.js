var Category = function(title) {
    var self = this;

    self.title = ko.observable(category);
}

var Location = function(marker) {
    var self = this;

    self.marker = marker;
    self.title = ko.observable();
    self.category = ko.observable();
    self.labels = ko.observableArray();
    self.lat = ko.observable();
    self.long = ko.observable();

    self.setTitle = function(title) {
        selt.title(title);
        self.marker.title = title;
    }

    self.setCategory = function(category) {
        self.category(category);
    }

    self.addLabel = function(label) {
        if (self.categories.indexOf(category) < 0) {
            self.categories.push(category);
        } else {
            alert("Location already belongs to category.");
        }
    }

    self.removeLabel = function(category) {
        self.categories.remove(category);
    }
}

var ViewModel = function() {
    var self = this;

    self.map;

    //self.initialize = function() {
    self.mapOptions = {
        zoom: 8,
        center: new google.maps.LatLng(-34.397, 150.644),
        panControl: true,
        panControlOptions: {
            position: google.maps.ControlPosition.RIGHT_BOTTOM
        },
        zoomControl: true,
        zoomControlOptions: {
            style: google.maps.ZoomControlStyle.SMALL,
            position: google.maps.ControlPosition.RIGHT_BOTTOM
        }
    };
    self.map = new google.maps.Map(document.getElementById('map-canvas'), self.mapOptions);

    if (localStorage.locations) {
        self.locations = JSON.parse(localStorage.locations); //ko.observableArray(localStorage.);
    } else {
        self.locations = [];//ko.observableArray();
    }

    console.log(self.locations);

    self.filteredLocations = ko.observableArray();

    google.maps.event.addListener(self.map, 'click', function(event) {
        var loc = new Location(new google.maps.Marker({
            position: event.latLng,
            map: self.map,
            draggable: true,
            title: "" +  new Date().getTime()
        }));

        console.log(loc.marker.position.lat() + ", " + loc.marker.position.lng());

        google.maps.event.addListener(loc.marker, 'dragend', function() {
            //console.log(self.locations);
            for (var i = 0; i < self.locations().length; i++) {
                console.log(self.locations()[i].title());
                console.log(self.locations()[i].marker.position.LatLng);
            };
            //console.log(self.locations());
        });

        self.locations.push(loc);
        //co
        localStorage.locations = JSON.stringify(self.locations);
    });

    //}

    google.maps.event.addDomListener(window, 'load', self.initialize);

    //self.initialize();
};

ko.applyBindings(new ViewModel());