/*
 NeighborhoodMap 2015-06-01 
*/$(document).ready(function(){function a(a,b,c){this.marker=new google.maps.Marker({position:new google.maps.LatLng(b,c),map:a,draggable:!0}),this.title=""}function b(){this.index="https://api.foursquare.com/v2",this.clientId="ERHT3FHFXMWICB0G4LBHE1GU51LFYBYP3JS0DJU2LPAZAXDR",this.clientSecret="1HPXTVYASF2DDEHPPN14XHEQW0B2R1WI4GDY1MVMTYZN3XGK",this.version="20130815",this.xhr=void 0}a.prototype.toJSON=function(){return{title:this.title,lat:this.marker.getPosition().lat(),lng:this.marker.getPosition().lng()}},function(){this.search=function(a,b){var c=[this.index,"venues","search"].join("/"),d={ll:a.ll,query:a.query,radius:50,client_id:this.clientId,client_secret:this.clientSecret,v:this.version,intent:"browse"};this.xhr&&4!=this.xhr.readyState&&(this.xhr.abort(),console.log("Aborted previous request")),this.xhr=$.get(c,d,b.success,"json"),this.xhr.fail(b.fail)}}.call(b.prototype);var c=function(){var c=this;c.allLocations=[],c.map=void 0,c.currentLocation=ko.observable({}),c.infowindow=void 0,c.locationSearchQuery=ko.observable(""),c.showAll=ko.observable(!1),c.showListView=ko.observable(!1),c.foursquareRequest=new b,c.showInfo=ko.observable(!1),c.showError=ko.observable(!1),c.showLocationSuggestions=ko.observable(!1),c.address=ko.observable(),c.checkinsCount=ko.observable(),c.tipCount=ko.observable(),c.usersCount=ko.observable(),c.locationSearchSuggestions=ko.computed(function(){var a,b=c.locationSearchQuery().toLowerCase();return""===b&&c.showListView()===!0?ko.utils.arrayFilter(c.allLocations,function(a){return a.marker.setVisible(!0),!0}):ko.utils.arrayFilter(c.allLocations,function(d){var e=d.title.toLowerCase().indexOf(b)>-1;return a=d.marker,a.setVisible(e),void 0===c.infowindow||e||c.infowindow.marker!=a||c.closeInfoWindow(),e})}),c.showLocationSearchDiv=ko.computed(function(){var a=!1;return a=c.showListView()===!0?!0:c.showLocationSuggestions()===!1?!1:""===c.locationSearchQuery()?!1:c.locationSearchSuggestions().length>0?!0:!1}),c.initialize=function(){c.mapOptions={zoom:16,center:new google.maps.LatLng(6.8412,79.874),panControl:!0,panControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.RIGHT_BOTTOM}},c.map=new google.maps.Map(document.getElementById("map-canvas"),c.mapOptions),c.loadLocations(),google.maps.event.addListener(c.map,"click",function(b){var d=new a(c.map,b.latLng.lat(),b.latLng.lng());c.addLocationEventListeners(d),google.maps.event.trigger(d.marker,"click")})},google.maps.event.addDomListener(window,"load",c.initialize),c.showList=function(){c.showListView(c.showListView()===!0?!1:!0)},c.initializeSearchText=function(){c.showLocationSuggestions(!0)},c.addLocationEventListeners=function(a){google.maps.event.addListener(a.marker,"click",function(){c.currentLocation(a),a.marker.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){a.marker.setAnimation(null)},1e3),c.showInfoWindow(),c.locationSearchQuery("")})},c.showLocation=function(a){c.currentLocation(a),c.showInfoWindow()},c.showInfoWindow=function(){var a=c.currentLocation();if(c.showInfo(!1),c.showError(!1),""!==c.currentLocation().title){var b=a.marker.getPosition();c.foursquareRequest.search({ll:[b.lat(),b.lng()].join(","),query:a.title},c.foursquareResponseHandler)}c.showLocationSuggestions(!1),c.locationSearchQuery(a.title),(void 0===c.infowindow||c.infowindow.marker!==a.marker)&&(void 0!==c.infowindow&&c.infowindow.close(),c.infowindow=new google.maps.InfoWindow({content:document.getElementById("infowindow-template").innerHTML}),c.infowindow.marker=a.marker,c.infowindow.open(c.map,a.marker),google.maps.event.addListener(c.infowindow,"domready",function(){ko.applyBindings(c,document.getElementById("infowindow"))}),google.maps.event.addListener(c.infowindow,"closeclick",function(){c.infowindow=void 0,c.locationSearchQuery("")}))},c.closeInfoWindow=function(){void 0!==c.infowindow&&(c.infowindow.close(),c.infowindow=void 0)},c.saveLocation=function(){var a=c.currentLocation(),b=c.allLocations.indexOf(a);b>-1?c.allLocations[b]=a:c.allLocations.push(a),localStorage.locations=JSON.stringify(c.allLocations),c.closeInfoWindow()},c.removeLocation=function(){var a=c.currentLocation();a.marker.setMap(null);var b=c.allLocations.indexOf(a);b>-1&&(c.allLocations.splice(b,1),localStorage.locations=JSON.stringify(c.allLocations),c.locationSearchQuery(""))},c.loadLocations=function(){var b,d,e;b=localStorage.locations&&"[]"!==localStorage.locations?JSON.parse(localStorage.locations):c.initializeData();for(var f=0;f<b.length;f++)d=b[f],e=new a(c.map,d.lat,d.lng),e.title=d.title,c.addLocationEventListeners(e),c.allLocations.push(e)},c.foursquareResponseHandler={success:function(a){var b=a.response.venues;if($.isEmptyObject(b))c.address("n/a"),c.checkinsCount("n/a"),c.tipCount("n/a"),c.usersCount("n/a");else{var d=b[0],e=d.stats;c.address(d.location.formattedAddress.join(",")),c.checkinsCount(e.checkinsCount||0),c.tipCount(e.tipCount),c.usersCount(e.usersCount)}c.showInfo(!0)},fail:function(){c.showError(!0)}},c.initializeData=function(){var a=[{title:"Cemetry",lat:6.844921938032888,lng:79.86549854278564},{title:"Odel",lat:6.841513169099581,lng:79.86700057983398},{title:"Berjaya Hotel",lat:6.838594391363253,lng:79.86378192901611},{title:"Lavinia Breeze",lat:6.840959241849386,lng:79.86290216445923},{title:"St. Thomas Collega",lat:6.837380004132014,lng:79.86509084701538},{title:"Mount Grill",lat:6.841640998373764,lng:79.86721515655518},{title:"Loon Tao",lat:6.83944659108594,lng:79.86315965652466},{title:"Eagle Lakeside Auditorium",lat:6.84072488781938,lng:79.8794674873352},{title:"Shore By O",lat:6.838360036173007,lng:79.86324548721313},{title:"Mount Breeze",lat:6.840320094223907,lng:79.86300945281982}];return a}};ko.applyBindings(new c)});